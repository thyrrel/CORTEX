# .github/workflows/main.yml

name: CORTEX - Validação de Persistência MySQL
on: [push, workflow_dispatch] # Permite execução manual e por push

jobs:
  validate_persistence:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        python3 -m pip install --upgrade pip
        # Instala o driver MySQL (definido em requirements.txt)
        pip install -r requirements.txt
        
    - name: Run CORTEX Integration Test (Persistence Check)
      # 1. Injeta os Secrets como variáveis de ambiente (CORTEX_DB_...)
      env:
        CORTEX_DB_HOST: ${{ secrets.CORTEX_DB_HOST }}
        CORTEX_DB_USER: ${{ secrets.CORTEX_DB_USER }}
        CORTEX_DB_PASS: ${{ secrets.CORTEX_DB_PASS }}
        CORTEX_DB_NAME: ${{ secrets.CORTEX_DB_NAME }}
        
      # 2. Executa o ponto de entrada principal que contém o teste de integração
      #    Se o save_task/load_task falhar, o script Python irá falhar e a Action para.
      run: |
        echo "Iniciando teste de persistência no MySQL..."
        python3 backend/core/main.py
        echo "Teste de persistência concluído com sucesso."
